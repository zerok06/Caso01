name: Deploy to Compute Engine (CI/CD)

on:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - "docs/**"

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCE_INSTANCE_IP }}
          username: ${{ secrets.GCE_SSH_USER }}
          password: ${{ secrets.GCE_SSH_PASSWORD }}
          script: |
            # 1. Configuración Inicial (Solo la primera vez o si cambia)
            # Instalar Docker si no existe
            if ! command -v docker &> /dev/null; then
                curl -fsSL https://get.docker.com -o get-docker.sh
                sudo sh get-docker.sh
                sudo usermod -aG docker $USER
            fi

            # Crear directorio de la app
            mkdir -p ~/app
            cd ~/app

            # 2. Obtener últimas cambios del Repositorio (CI/CD)
            # Si el directorio .git no existe, clonamos. Si existe, hacemos pull.
            if [ ! -d ".git" ]; then
                git clone https://github.com/${{ github.repository }} .
            else
                git fetch origin
                git reset --hard origin/main
            fi

            # 3. Inyectar Variables de Entorno (Secrets)
            echo "${{ secrets.ENV_FILE_PRODUCTION }}" > .env

            # 4. Desplegar con Docker Compose
            # --build asegura que se reconstruyan las imágenes con el nuevo código
            docker compose -f docker-compose.prod.yml down --remove-orphans
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans

            # 5. Limpieza de imágenes antiguas para no llenar disco
            docker system prune -f
