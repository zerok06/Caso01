name: Deploy MySQL

on:
    workflow_dispatch:

env:
    PROJECT_ID: tivit-caso01
    REGION: us-central1
    SERVICE: ia-mysql

jobs:
    deploy:
        name: Deploy MySQL
        runs-on: ubuntu-latest
        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Google Auth
              uses: "google-github-actions/auth@v2"
              with:
                  credentials_json: "${{ secrets.GCP_SA_KEY }}"

            - name: Deploy to Cloud Run
              uses: google-github-actions/deploy-cloudrun@v2
              with:
                  service: ${{ env.SERVICE }}
                  region: ${{ env.REGION }}
                  image: mysql:8.0
                  # WARNING: Data is ephemeral without volumes.
                  # We must pass the root password via environment variables
                  env_vars: |
                      MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
                      MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
                      MYSQL_USER=${{ secrets.MYSQL_USER }}
                      MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
                  flags: "--port=3306"
