name: Deploy Celery Worker

on:
    push:
        branches:
            - main
        paths:
            - "backend/**"
            - ".github/workflows/deploy-worker.yml"
    workflow_dispatch:

env:
    PROJECT_ID: tivit-caso01
    REGION: us-central1
    GAR_LOCATION: us-central1
    REPOSITORY: cloud-run-source-deploy
    SERVICE: ia-celery-worker

jobs:
    deploy:
        name: Deploy Worker
        runs-on: ubuntu-latest
        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Google Auth
              uses: "google-github-actions/auth@v2"
              with:
                  credentials_json: "${{ secrets.GCP_SA_KEY }}"

            - name: Docker Auth
              run: |
                  gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

            # Note: We build the same image as the backend, but deploying it as a separate service
            - name: Build and Push
              run: |
                  docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }} ./backend
                  docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }}

            - name: Deploy to Cloud Run
              uses: google-github-actions/deploy-cloudrun@v2
              with:
                  service: ${{ env.SERVICE }}
                  region: ${{ env.REGION }}
                  image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }}
                  # Override the CMD to run our worker script instead of uvicorn
                  entrypoint: ./worker_entrypoint.sh
                  # Important: Cloud Run usually times out requests after 60 mins max.
                  # For a worker, we want it 'always on' if using min-instances, or just robust handling.
                  # We set min-instances to 1 to simulate a persistent worker (optional, can incur costs)
                  # flags: '--min-instances=1'
                  env_vars: |
                      DATABASE_URL=${{ secrets.DATABASE_URL }}
                      REDIS_URL=${{ secrets.REDIS_URL }}
                      QDRANT_URL=${{ secrets.QDRANT_URL }}
                      RAG_SERVICE_URL=${{ secrets.RAG_SERVICE_URL }}
                      RAG_SERVICE_API_KEY=${{ secrets.RAG_SERVICE_API_KEY }}
                      RAG_SERVICE_ENABLED=true
                      GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}
                      GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
                      DOCUMENT_AI_PROCESSOR_ID=${{ secrets.DOCUMENT_AI_PROCESSOR_ID }}
                      DOCUMENT_AI_LOCATION=${{ secrets.DOCUMENT_AI_LOCATION }}
                      ENABLE_NATURAL_LANGUAGE=true
                      LLM_PROVIDER=gemini
                      OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
